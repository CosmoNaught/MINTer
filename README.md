## Introduction

MINTer (Malaria INTervention emulator in R) is an R package that provides fast emulation of malaria transmission models based off malariasimulation (link!). It offers two main workflows:

1. **Full simulation + emulation**: Run detailed malaria simulations and then use trained neural networks to emulate the results
2. **Direct emulation**: Skip the simulation step and directly generate predictions using pre-trained models

The package uses torch (implemented in Python) base nerual network models (GRU and LSTM) to provide rapid predictions of malaria prevalence and clinical cases under various intervention scenarios.

## Installation

You can install MINTer from GitHub:


``` r
# Install devtools if you haven't already
if (!requireNamespace("devtools", quietly = TRUE)) {
  install.packages("devtools")
}

# Install MINTer
devtools::install_github("CosmoNaught/MINTer")
```

### Dependencies

MINTer requires Python with PyTorch installed for the neural network models. The package will automatically set up the Python environment when first loaded:


``` r
library(MINTer)
```

For database mode (Option 2 below), you'll also need the segMINT package:


``` r
# Install segMINT for database functionality
devtools::install_github("CosmoNaught/segMINT")
```

## Quick Start

There are two main ways to use MINTer:

### Option 1: Direct Emulation (Fastest)

If you want quick predictions without running full simulations:


``` r
library(MINTer)

# Create scenarios

# Create intervention scenarios
intervention_scenarios <- create_scenarios(
  eir = c(5.2, 35.8, 180.5),
  dn0_use = c(0.15, 0.35, 0.55),
  dn0_future = c(0.20, 0.45, 0.65),
  Q0 = c(0.65, 0.75, 0.85),
  phi_bednets = c(0.45, 0.65, 0.75),
  seasonal = c(0, 1, 1),
  routine = c(0, 0, 1),
  itn_use = c(0.25, 0.55, 0.85),
  irs_use = c(0.10, 0.35, 0.70),
  itn_future = c(0.30, 0.60, 0.90),
  irs_future = c(0.15, 0.40, 0.75),
  lsm = c(0.05, 0.45, 0.85)
)

# Run emulator
results <- MINTer::run_malaria_emulator(
  scenarios = scenarios,
  predictor = 'cases',
  output_dir = 'scenario_output',
  model_types = c('GRU', 'LSTM')
)
```

### Option 2: Full Simulation + Database + Emulation

For more detailed analysis with access to full simulation data:


``` r
library(MINTer)
library(segMINT)  # Required for database creation

# Step 1: Create scenarios for simulation
scenarios <- MINTer::create_malariasim_scenarios(
  eir = c(5.2, 35.8, 180.5),
  dn0_use = c(0.15, 0.35, 0.55),
  dn0_future = c(0.20, 0.45, 0.65),
  Q0 = c(0.65, 0.75, 0.85),
  phi_bednets = c(0.45, 0.65, 0.75),
  seasonal = c(0, 1, 1),
  routine = c(0, 0, 1),
  itn_use = c(0.25, 0.55, 0.85),
  irs_use = c(0.10, 0.35, 0.70),
  itn_future = c(0.30, 0.60, 0.90),
  irs_future = c(0.15, 0.40, 0.75),
  lsm = c(0.05, 0.45, 0.85)
)

# Step 2: Run malaria simulations
MINTer::run_malariasim(
  max_threads = 12,
  lhs_scenario = "Data/malariasim_scenarios.csv",
  output_dir = "Data/Simout"
)

# Step 3: Create database from simulation results
segMINT::create_database(
  dir = "/path/to/your/working/dir/Data/Database", 
  file_name = "malariasim_database.duckdb", # custom name
  table_name = "simulation_results", # custom name
  data_dir = "/path/to/your/working/dir/Data/Simout",
  N = "all",
  randomize = FALSE
)

# Step 4: Run emulator with counterfactual analysis for your 3rd malariasimulation scenario to explore prevalence changes across a range of EIR values
MINTer::run_malaria_emulator(
  db_path = "/path/to/your/working/dir/Data/Database/malariasim_database.duckdb",
  param_index = 3,
  predictor = "prevalence",
  counterfactual = list(eir = c(0.5, 60, 300)),
  output_dir = "counterfactuals_output"
)

```

## Understanding the model Parameters

### Intervention Parameters

- **eir**: Entomological Inoculation Rate - annual number of infectious bites per person
- **itn_use** / **itn_future**: Current and future insecticide-treated net (ITN) coverage
- **irs_use** / **irs_future**: Current and future indoor residual spraying (IRS) coverage
- **lsm**: Larval source management coverage (0-1)

### Bednet Parameters

- **dn0_use** / **dn0_future**: Bednet effectiveness against mosquito bites (0-1)
- **phi_bednets**: Proportion of mosquito bites occurring when humans are in bed
- **routine**: Whether routine bednet distribution is implemented (0=no, 1=yes)

### Mosquito Parameters

- **Q0**: Human blood index - proportion of blood meals taken from humans
- **seasonal**: Transmission pattern (0=perennial/year-round, 1=seasonal)

## Interpreting Results

### Understanding the Plots

All plots generated by MINTer include:
- **Time axis**: Shown in years (0-6 years by default)
- **Vertical line at year 3**: Indicates the transition between "current" and "future" intervention coverage
- **Model predictions**: Lines showing GRU and/or LSTM predictions
- **For database mode**: Dashed lines show actual simulation results for comparison

### Prevalence Predictions

When using `predictor = "prevalence"`, the emulator predicts malaria prevalence in children under 5 years old:


``` r
# Results include:
# - Timesteps in days (converted to years in plots)
# - Predicted prevalence values (0-1)
# - Comparison between GRU and LSTM models
# - Y-axis: Proportion infected (0 = 0%, 1 = 100%)
```

### Clinical Cases Predictions

When using `predictor = "cases"`, the emulator predicts clinical cases per 1000 population:


``` r
# Results include:
# - Timesteps in 14-day intervals
# - Cases per 1000 population per 14 days
# - Model comparisons
# - Y-axis: Clinical incidence rate
```

## Tips and Best Practices

1. **Start with scenario mode** for quick exploration of parameter space
2. **Use database mode** when you need:
   - Access to full simulation data
   - Counterfactual analysis on existing simulations
   - Validation against simulation results
3. **Parameter ranges (NOTE TO EXPAND ON THIS!)**:
   - Keep coverage parameters (itn_use, irs_use, lsm) between 0 and 1
   - EIR typically ranges from 0.1 to 500+
   - Effectiveness parameters (dn0) should be between 0 and 1
4. **Computational resources**:
   - Scenario mode is very fast (seconds)
   - Full simulations can take anywhere from minutes to hours depending on the number of scenarios so be careful when assigning large jobs ensure you have appropriate resources
   - Use `max_threads` to control parallel processing

## Troubleshooting

### Python/PyTorch Issues

If you encounter Python-related errors:


``` r
# Check Python configuration
reticulate::py_config()

# The package automatically initializes Python when loaded
# If you need to reinitialize:
MINTer::initialize_python(verbose = TRUE)
```
